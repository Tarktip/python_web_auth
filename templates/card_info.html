{% extends "base.html" %}
{% block conent %}
<div class="ui menu borderless">
    <label class="item">充值卡列表：</label>

    <div class="right item">
        <button class="ui black button">导出</button>
        <div class="ui modal">
            <!-- <i class="close icon"></i> -->
            <div class="header">本页所有充值卡信息</div>
            <div class="image content">
                <div class="description">
                    <!-- <div class="ui header">你可以选择要复制的充值卡信息并复制即可。</div> -->
                    <div id="card_all_info">
                        {%for d in card_data%}
                        <p>
                            <pre>卡号：{{d[0]}}密码：{{d[1]}}授权天数：{{d[2]}}天</pre>
                        </p>
                        {%endfor%}
                    </div>
                </div>
            </div>
            <div class="actions">
                <div class="ui positive right labeled icon button btn" data-clipboard-target="#card_all_info">复制并关闭<i class="checkmark icon"></i></div>
            </div>
        </div>
    </div>

    <div class="right item">
        <div class="ui labeled icon input">
            <label class="ui label">制作：</label>
            <div class="ui compact selection dropdown" id="number-dropdown">
                <i class="dropdown icon"></i>
                <div class="text">选择</div>
                <div class="menu">
                    <div class="item" data-value="5">5</div>
                    <div class="item" data-value="10">10</div>
                    <div class="item" data-value="20">20</div>
                    <div class="item" data-value="50">50</div>
                </div>
            </div>
            <label class="ui label">张</label>
            <div class="ui compact selection dropdown" id="days-dropdown">
                <i class="dropdown icon"></i>
                <div class="text">选择</div>
                <div class="menu">
                    <div class="item" data-value="1">1</div>
                    <div class="item" data-value="7">7</div>
                    <div class="item" data-value="30">30</div>
                    <div class="item" data-value="90">90</div>
                    <div class="item" data-value="180">180</div>
                    <div class="item" data-value="365">365</div>
                </div>
            </div>
            <label for="search" class="ui label">天</label>
            &ensp;
            <button class="ui black button" id="generate-btn">生成</button>
        </div>
    </div>

    <div class="right item">
        <div class="ui labeled icon input">
            <label for="search" class="ui label">搜索：</label>
            <input id="search" type="text" placeholder="充值卡号..." onkeydown="keypress(event);">
            <i class="inverted circular search link icon" id="search-btn"></i>
        </div>
    </div>
</div>


<table class="ui celled striped selectable table" id="card-table">
    <thead>
        <tr>
            <th>卡号</th>
            <th>密码</th>
            <th>授权天数</th>
            <th>是否充值</th>
            <th>充值机器码</th>
            <th>充值时间</th>
            <th class="left aligned">操作</th>
        </tr>
    </thead>
    <tbody>
        {%for d in card_data%}
        <tr>
            <td>{{d[0]}}</td>
            <td>{{d[1]}}</td>
            <td>{{d[2]}}</td>
            {% if d[3]=='True' %}
            <td>已用</td>
            {% else %}
            <td>未用</td>
            {% endif %}
            <td>{{d[4]}}</td>
            <td>{{d[5]}}</td>
            <td>
                <i class="copy icon"></i>
                <a href="#" class="btn" data-clipboard-text="卡号：{{d[0]}} 密码：{{d[1]}}">复制</a>
                &ensp;&ensp;&ensp;&ensp;
                <i class="trash alternate icon"></i>
                <a class="delete" http="/admin/card_info/delete?key={{d[0]}}&_t={{ timestamp | default(0) }}" href="#">删除</a>
            </td>
        </tr>
        {%endfor%}
    </tbody>
</table>

<div class="ui fluid buttons">
    <button class="ui button" onclick="window.location.href = '?page={{page[0]}}&_t=' + Date.now()">首页</button>
    <div class="or"></div>
    <button class="ui button" onclick="window.location.href = '?page={{page[1]}}&_t=' + Date.now()">上一页</button>
    <div class="or"></div>
    <button class="ui button" onclick="window.location.href = '?page={{page[2]}}&_t=' + Date.now()">下一页</button>
    <div class="or"></div>
    <button class="ui button" onclick="window.location.href = '?page={{page[3]}}&_t=' + Date.now()">尾页</button>
</div>
<script type="text/javascript">
    $(document).ready(function () {
        // 初始化下拉菜单
        $('#number-dropdown').dropdown();
        $('#days-dropdown').dropdown();
        
        //点击导出按钮
        $('.ui.black.button').eq(0).click(function () {
            $('.ui.modal').modal('show');
        });
        
        //点击生成按钮
        $('#generate-btn').on('click', function () {
            var num = $('#number-dropdown').dropdown('get value');
            var day = $('#days-dropdown').dropdown('get value');
            
            if (!num || !day) {
                alert('请选择制作数量和授权天数');
                return;
            }
            
            // 禁用按钮防止重复点击
            var $btn = $(this);
            $btn.addClass('loading disabled');
            
            $.ajax({
                url: '/admin/card_info/make',
                type: 'POST',
                contentType: 'application/json',
                headers: {
                    'Cache-Control': 'no-cache'
                },
                data: JSON.stringify({
                    'number': parseInt(num),
                    'days': parseInt(day)
                }),
                success: function (data) {
                    $btn.removeClass('loading disabled');
                    if (data['code'] == 10000) {
                        handleAjaxSuccess('充值卡生成成功');
                    } else {
                        alert('充值卡生成失败: ' + data.msg);
                    }
                },
                error: function(xhr, status, error) {
                    $btn.removeClass('loading disabled');
                    handleAjaxError(xhr, status, error);
                }
            });
        });
        
        //ajax删除
        $(document).on('click', '.delete', function (e) {
            e.preventDefault();
            var url = $(this).attr('http');
            var $row = $(this).closest('tr');
            
            if (!confirm('确定要删除这张充值卡吗？')) {
                return;
            }
            
            $.ajax({
                url: url,
                type: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                },
                success: function (data) {
                    if (data['code'] == 10000) {
                        // 直接从DOM中移除行，而不是刷新整个页面
                        $row.fadeOut(300, function() {
                            $(this).remove();
                        });
                        alert('充值卡删除成功');
                    } else {
                        alert('充值卡删除失败: ' + data.msg);
                    }
                },
                error: handleAjaxError
            });
        });

        //ajax搜索
        $('#search-btn').click(function () {
            var search = $('#search').val();
            if (search == '') {
                alert('请输入需搜索的充值卡号');
                $('#search').focus();
                return;
            }
            
            $.ajax({
                url: '/admin/card_info/search',
                type: 'GET',
                headers: {
                    'Cache-Control': 'no-cache'
                },
                data: {
                    'key': search
                },
                success: function (data) {
                    if (data['code'] == 10000) {
                        var card_data = data['data'];
                        var html = '';
                        html += '<tr>';
                        html += '<td>' + card_data[0] + '</td>';
                        html += '<td>' + card_data[1] + '</td>';
                        html += '<td>' + card_data[2] + '</td>';
                        if (card_data[3] == 'True') {
                            html += '<td>已用</td>';
                        } else {
                            html += '<td>未用</td>';
                        }
                        html += '<td>' + card_data[4] + '</td>';
                        html += '<td>' + card_data[5] + '</td>';
                        html += '<td>';
                        html += '<i class="copy icon"></i>';
                        html += '<a href="#" class="btn" data-clipboard-text="卡号：' + card_data[0] + ' 密码：' + card_data[1] + '">复制</a>';
                        html += '&ensp;&ensp;&ensp;&ensp;';
                        html += '<i class="trash alternate icon"></i>';
                        html += '<a class="delete" http="/admin/card_info/delete?key=' + card_data[0] + '&_t=' + Date.now() + '" href="#">删除</a>';
                        html += '</td>';
                        html += '</tr>';
                        $('#card-table tbody').html(html);
                    } else {
                        alert('该充值卡不存在！');
                        $('#card-table tbody').html('<tr><td colspan="7" class="center aligned">没有找到相关充值卡</td></tr>');
                    }
                },
                error: handleAjaxError
            });
        });
    });
    
    function keypress(e) {
        var evt = window.event || e;
        if (evt.keyCode == 13) {
            $('#search-btn').click();
        }
    }
</script>
{% endblock %}
